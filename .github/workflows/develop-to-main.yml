name: REACION DE RELEASE AUTOMATICA
run-name: CREACION DE RELEASE AUTOMATICA ${{ github.run_number }}
permissions:
  contents: write
on:
  pull_request:
    types:
      - closed
    branches:
      - main

jobs:
  run-on-merge:
    if: >-
      github.event.pull_request.merged == true &&
      github.event.pull_request.base.ref == 'main' &&
      (
        startsWith(github.event.pull_request.head.ref, 'hotfix') ||
        startsWith(github.event.pull_request.head.ref, 'release')
      )
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      - name: Print message
        run: |
          if [[ "${{ github.event.pull_request.head.ref }}" == hotfix* ]]; then
            echo "Se ha hecho merge de un PR de hotfix a main."
          elif [[ "${{ github.event.pull_request.head.ref }}" == release* ]]; then
            echo "Se ha hecho merge de un PR de release a main."
          fi
      - name: Additional steps
        run: |
          echo "Aquí agregar más pasos según sea necesario."

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.10" # Asegúrate de que esté en la versión correcta

      # 3. Instalar dependencias necesarias
      - name: Instalar dependencias
        run: |
          python -m pip install --upgrade pip

      # 4. Crear un tag y release con el script Python
      - name: Crear tag y release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }} # El token de autenticación de GitHub Actions
        run: |
          VERSION=v$(echo "${{ github.event.pull_request.head.ref }}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          if [ -z "$VERSION" ] || [ "$VERSION" = "v" ]; then
            echo "ERROR:No se pudo extraer la versión del nombre de la rama (${GITHUB_HEAD_REF:-${{ github.event.pull_request.head.ref }}})"
            exit 1
          fi
          # Obtener historial de commits entre main y la rama de release
          git fetch origin main "${{ github.event.pull_request.head.ref }}"
          CHANGELOG=$(git log --pretty=format:"%h %s (%an) %as" origin/main..origin/${{ github.event.pull_request.head.ref }})
          DESCRIPCION=$(cat <<EOF
          Release generado automáticamente desde ${{ github.event.pull_request.head.ref }}

          ## Commits incluidos:
          $CHANGELOG
          EOF
          )
          python .github/workflows/scripts/crear_release.py \
            --repo "${{ github.repository }}" \
            --version "$VERSION" \
            --nombre_release "Release $VERSION" \
            --descripcion "$DESCRIPCION"

      - name: Crear o actualizar CHANGELOG.md
        run: |
          VERSION=v$(echo "${{ github.event.pull_request.head.ref }}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          PR_BODY="${{ github.event.pull_request.body }}"
          python .github/workflows/scripts/crear_changelog.py --version "$VERSION" --pr-body "$PR_BODY"

      - name: Configurar Git
        run: |
          git config --global user.name "github-actions[bot]"
          git config --global user.email "github-actions[bot]@users.noreply.github.com"

      - name: Commit y push del CHANGELOG.md
        run: |
          VERSION=v$(echo "${{ github.event.pull_request.head.ref }}" | grep -oE '[0-9]+\.[0-9]+\.[0-9]+')
          git add CHANGELOG.md
          git commit -m "chore: actualizar CHANGELOG.md para versión $VERSION" || echo "No hay cambios en CHANGELOG.md"
          git push origin main

      - name: Sincronizar CHANGELOG.md con develop
        run: |
          git fetch origin develop
          git checkout develop
          git merge origin/main -m "chore: sincronizar CHANGELOG.md desde main" --allow-unrelated-histories
          git push origin develop
